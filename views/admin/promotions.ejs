<%- include('../partials/header', { title: 'إدارة العروض الترويجية', activePage: 'promotions', admin: true }) %>

<div class="d-flex justify-content-between align-items-center mb-4">
    <h1 class="h2">إدارة العروض الترويجية</h1>
    <button class="btn btn-primary" data-bs-toggle="modal" data-bs-target="#addPromotionModal">
        <i class="bi bi-plus-circle"></i> إضافة عرض ترويجي
    </button>
</div>

<div class="card shadow mb-4">
    <div class="card-header py-3">
        <h6 class="m-0 font-weight-bold text-primary">العروض الترويجية الحالية</h6>
    </div>
    <div class="card-body">
        <div class="table-responsive">
            <table class="table table-bordered" id="promotionsTable" width="100%" cellspacing="0">
                <thead>
                    <tr>
                        <th>المعرف</th>
                        <th>الكود</th>
                        <th>الصورة</th>
                        <th>الوصف</th>
                        <th>نوع الخصم</th>
                        <th>القيمة</th>
                        <th>فترة الصلاحية</th>
                        <th>الحالة</th>
                        <th>الإجراءات</th>
                    </tr>
                </thead>
                <tbody>
                    <% promotions.forEach(promotion => { %>
                        <tr>
                            <td><%= promotion.id %></td>
                            <td><%= promotion.code %></td>
                            <td><img src="<%= promotion.image_url %>" alt="<%= promotion.code %>" width="50"></td>
                            <td><%= promotion.description || '-' %></td>
                            <td>
                                <% if (promotion.discount_type === 'percentage') { %>
                                    نسبة مئوية
                                <% } else { %>
                                    مبلغ ثابت
                                <% } %>
                            </td>
                            <td>
                                <% if (promotion.discount_type === 'percentage') { %>
                                    <%= promotion.value %>%
                                <% } else { %>
                                    <%= promotion.value %> ريال
                                <% } %>
                            </td>
                            <td>
                                <%= new Date(promotion.valid_from).toLocaleDateString('ar-SA') %> - 
                                <%= new Date(promotion.valid_until).toLocaleDateString('ar-SA') %>
                            </td>
                            <td>
                                <% if (promotion.is_active) { %>
                                    <span class="badge bg-success">نشط</span>
                                <% } else { %>
                                    <span class="badge bg-danger">غير نشط</span>
                                <% } %>
                            </td>
                            <td>
                                <button class="btn btn-sm btn-warning" onclick="editPromotion(<%= promotion.id %>)">
                                    <i class="bi bi-pencil"></i>
                                </button>
                                <button class="btn btn-sm btn-danger" onclick="deletePromotion(<%= promotion.id %>)">
                                    <i class="bi bi-trash"></i>
                                </button>
                            </td>
                        </tr>
                    <% }); %>
                </tbody>
            </table>
        </div>
    </div>
</div>

<!-- نافذة إضافة عرض ترويجي -->
<div class="modal fade" id="addPromotionModal" tabindex="-1" aria-labelledby="addPromotionModalLabel" aria-hidden="true">
    <div class="modal-dialog">
        <div class="modal-content">
            <div class="modal-header">
                <h5 class="modal-title" id="addPromotionModalLabel">إضافة عرض ترويجي جديد</h5>
                <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
            </div>
            <div class="modal-body">
                <form id="addPromotionForm">
                    <div class="mb-3">
                        <label for="promoCode" class="form-label">كود العرض</label>
                        <input type="text" class="form-control" id="promoCode" required>
                    </div>
                    <div class="mb-3">
                        <label for="promoDescription" class="form-label">الوصف</label>
                        <textarea class="form-control" id="promoDescription" rows="2"></textarea>
                    </div>
                    <div class="mb-3">
                        <label for="promoImage" class="form-label">الصورة</label>
                        <input type="file" class="form-control" id="promoImage" name="image">
                    </div>
                    <div class="mb-3">
                        <label for="discountType" class="form-label">نوع الخصم</label>
                        <select class="form-select" id="discountType" required>
                            <option value="percentage">نسبة مئوية</option>
                            <option value="fixed">مبلغ ثابت</option>
                        </select>
                    </div>
                    <div class="mb-3">
                        <label for="discountValue" class="form-label">قيمة الخصم</label>
                        <input type="number" class="form-control" id="discountValue" step="0.01" required>
                    </div>
                    <div class="row">
                        <div class="col-md-6">
                            <div class="mb-3">
                                <label for="validFrom" class="form-label">تاريخ البدء</label>
                                <input type="date" class="form-control" id="validFrom" required>
                            </div>
                        </div>
                        <div class="col-md-6">
                            <div class="mb-3">
                                <label for="validUntil" class="form-label">تاريخ الانتهاء</label>
                                <input type="date" class="form-control" id="validUntil" required>
                            </div>
                        </div>
                    </div>
                    <div class="form-check form-switch">
                        <input class="form-check-input" type="checkbox" id="isActive" checked>
                        <label class="form-check-label" for="isActive">
                            نشط
                        </label>
                    </div>
                </form>
            </div>
            <div class="modal-footer">
                <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">إلغاء</button>
                <button type="button" class="btn btn-primary" onclick="savePromotion()">حفظ</button>
            </div>
        </div>
    </div>
</div>

<!-- نافذة تعديل عرض ترويجي -->
<div class="modal fade" id="editPromotionModal" tabindex="-1" aria-labelledby="editPromotionModalLabel" aria-hidden="true">
    <div class="modal-dialog">
        <div class="modal-content">
            <div class="modal-header">
                <h5 class="modal-title" id="editPromotionModalLabel">تعديل العرض الترويجي</h5>
                <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
            </div>
            <div class="modal-body">
                <form id="editPromotionForm">
                    <input type="hidden" id="editPromotionId" name="id">
                    <div class="mb-3">
                        <label for="editPromoCode" class="form-label">كود العرض</label>
                        <input type="text" class="form-control" id="editPromoCode" required>
                    </div>
                    <div class="mb-3">
                        <label for="editPromoDescription" class="form-label">الوصف</label>
                        <textarea class="form-control" id="editPromoDescription" rows="2"></textarea>
                    </div>
                    <div class="mb-3">
                        <label for="editPromoImage" class="form-label">الصورة</label>
                        <input type="file" class="form-control" id="editPromoImage" name="image">
                    </div>
                    <div class="mb-3">
                        <label for="editDiscountType" class="form-label">نوع الخصم</label>
                        <select class="form-select" id="editDiscountType" required>
                            <option value="percentage">نسبة مئوية</option>
                            <option value="fixed">مبلغ ثابت</option>
                        </select>
                    </div>
                    <div class="mb-3">
                        <label for="editDiscountValue" class="form-label">قيمة الخصم</label>
                        <input type="number" class="form-control" id="editDiscountValue" step="0.01" required>
                    </div>
                    <div class="row">
                        <div class="col-md-6">
                            <div class="mb-3">
                                <label for="editValidFrom" class="form-label">تاريخ البدء</label>
                                <input type="date" class="form-control" id="editValidFrom" required>
                            </div>
                        </div>
                        <div class="col-md-6">
                            <div class="mb-3">
                                <label for="editValidUntil" class="form-label">تاريخ الانتهاء</label>
                                <input type="date" class="form-control" id="editValidUntil" required>
                            </div>
                        </div>
                    </div>
                    <div class="form-check form-switch">
                        <input class="form-check-input" type="checkbox" id="editIsActive">
                        <label class="form-check-label" for="editIsActive">
                            نشط
                        </label>
                    </div>
                </form>
            </div>
            <div class="modal-footer">
                <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">إلغاء</button>
                <button type="button" class="btn btn-primary" onclick="updatePromotion()">حفظ التغييرات</button>
            </div>
        </div>
    </div>
</div>

<%- include('../partials/footer') %>

<script>
    function savePromotion() {
        const form = document.getElementById('addPromotionForm');
        const formData = new FormData(form);
        formData.append('code', document.getElementById('promoCode').value);
        formData.append('description', document.getElementById('promoDescription').value);
        formData.append('discount_type', document.getElementById('discountType').value);
        formData.append('value', document.getElementById('discountValue').value);
        formData.append('valid_from', document.getElementById('validFrom').value);
        formData.append('valid_until', document.getElementById('validUntil').value);
        formData.append('is_active', document.getElementById('isActive').checked);
        const imageInput = document.getElementById('promoImage');
        if (imageInput.files.length > 0) {
            formData.append('image', imageInput.files[0]);
        }

        fetch('/admin/promotions', {
            method: 'POST',
            body: formData
        })
        .then(response => response.json())
        .then(data => {
            if (data.success) {
                location.reload();
            } else {
                alert('حدث خطأ أثناء حفظ العرض الترويجي');
            }
        })
        .catch(error => {
            console.error('Error:', error);
            alert('حدث خطأ أثناء حفظ العرض الترويجي');
        });
    }
    
    function editPromotion(id) {
        fetch(`/admin/promotions/${id}`)
        .then(response => response.json())
        .then(data => {
            document.getElementById('editPromotionId').value = data.id;
            document.getElementById('editPromoCode').value = data.code;
            document.getElementById('editPromoDescription').value = data.description || '';
            document.getElementById('editDiscountType').value = data.discount_type;
            document.getElementById('editDiscountValue').value = data.value;
            document.getElementById('editValidFrom').value = data.valid_from;
            document.getElementById('editValidUntil').value = data.valid_until;
            document.getElementById('editIsActive').checked = data.is_active;
            
            const modal = new bootstrap.Modal(document.getElementById('editPromotionModal'));
            modal.show();
        })
        .catch(error => {
            console.error('Error:', error);
            alert('حدث خطأ أثناء تحميل بيانات العرض الترويجي');
        });
    }
    
    function updatePromotion() {
        const id = document.getElementById('editPromotionId').value;
        const form = document.getElementById('editPromotionForm');
        const formData = new FormData(form);
        formData.append('code', document.getElementById('editPromoCode').value);
        formData.append('description', document.getElementById('editPromoDescription').value);
        formData.append('discount_type', document.getElementById('editDiscountType').value);
        formData.append('value', document.getElementById('editDiscountValue').value);
        formData.append('valid_from', document.getElementById('editValidFrom').value);
        formData.append('valid_until', document.getElementById('editValidUntil').value);
        formData.append('is_active', document.getElementById('editIsActive').checked);
        const imageInput = document.getElementById('editPromoImage');
        if (imageInput.files.length > 0) {
            formData.append('image', imageInput.files[0]);
        }

        fetch(`/admin/promotions/${id}`, {
            method: 'PUT',
            body: formData
        })
        .then(response => response.json())
        .then(data => {
            if (data.success) {
                location.reload();
            } else {
                alert('حدث خطأ أثناء تحديث العرض الترويجي');
            }
        })
        .catch(error => {
            console.error('Error:', error);
            alert('حدث خطأ أثناء تحديث العرض الترويجي');
        });
    }
    
    function deletePromotion(id) {
        if (confirm('هل أنت متأكد من حذف هذا العرض الترويجي؟')) {
            fetch(`/admin/promotions/${id}`, {
                method: 'DELETE'
            })
            .then(response => response.json())
            .then(data => {
                if (data.success) {
                    location.reload();
                } else {
                    alert('حدث خطأ أثناء حذف العرض الترويجي');
                }
            })
            .catch(error => {
                console.error('Error:', error);
                alert('حدث خطأ أثناء حذف العرض الترويجي');
            });
        }
    }
</script>